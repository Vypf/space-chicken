# Stage 1: Build web export using godot-ci
FROM barichello/godot-ci:4.5 AS builder

WORKDIR /game
COPY . .

# Import assets first
RUN godot --headless --path /game --editor --quit-after 2 || true

# Export web build
RUN mkdir -p /game/build/web && \
    godot --headless --verbose --path /game --export-release "Web" /game/build/web/index.html

# Stage 2: Nginx to serve the web build
FROM nginx:alpine

# Copy nginx config with required headers for Godot
COPY nginx.web.conf /etc/nginx/conf.d/default.conf

# Copy the web build
COPY --from=builder /game/build/web /usr/share/nginx/html

EXPOSE 80
